<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –£–ª—É—á—à–µ–Ω–∏–π Raider.IO</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>–û–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä –£–ª—É—á—à–µ–Ω–∏–π Raider.IO</h1>
            <div class="subtitle">–ù–∞–π–¥–∏—Ç–µ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –∂–µ–ª–∞–µ–º–æ–º—É —Å—Ä–µ–¥–Ω–µ–º—É —É—Ä–æ–≤–Ω—é –ø—Ä–µ–¥–º–µ—Ç–æ–≤</div>
        </header>

        <div class="main-content">
            <div class="form-section">
                <h2>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
                <form id="characterForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="region">–†–µ–≥–∏–æ–Ω:</label>
                            <select id="region" required>
                                <option value="eu">–ï–≤—Ä–æ–ø–∞ (EU)</option>
                                <option value="us">–°–®–ê (US)</option>
                                <option value="kr">–ö–æ—Ä–µ—è (KR)</option>
                                <option value="tw">–¢–∞–π–≤–∞–Ω—å (TW)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="realm">–°–µ—Ä–≤–µ—Ä:</label>
                            <input type="text" id="realm" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞..." required autocomplete="off">
                            <div id="realmSuggestions" class="suggestions"></div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="character_name">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
                            <input type="text" id="character_name" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" required>
                        </div>

                        <div class="form-group">
                            <label for="target_average">–¶–µ–ª–µ–≤–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:</label>
                            <input type="number" id="target_average" step="0.1" min="0" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 720.5" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="strategy">–°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:</label>
                            <select id="strategy">
                                <option value="balanced">–≠–∫–æ–Ω–æ–º–∏—á–Ω–∞—è (–º–∏–Ω–∏–º—É–º —Ä–µ—Å—É—Ä—Å–æ–≤)</option>
                                <option value="cost_efficient">–¢—â–∞—Ç–µ–ª—å–Ω–∞—è (–º–∞–∫—Å–∏–º—É–º —Ä–µ—Å—É—Ä—Å–æ–≤)</option>
                                <option value="fastest">–ë—ã—Å—Ç—Ä–∞—è (—Å—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥)</option>
                            </select>
                            <div class="strategy-description" id="strategyDescription">
                                –≠–∫–æ–Ω–æ–º–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –∑–∞—Ç—Ä–∞—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏.
                            </div>
                        </div>
                    </div>

                    <div class="advanced-options">
                        <div class="advanced-toggle" id="advancedToggle">
                            <span>‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </div>
                        <div class="advanced-content" id="advancedContent" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="max_crafted_items">–ú–∞–∫—Å–∏–º—É–º –∏–∑–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤:</label>
                                    <input type="number" id="max_crafted_items" min="0" max="9" value="9">
                                </div>
                                <div class="form-group">
                                    <label for="budget_limit">–õ–∏–º–∏—Ç –±—é–¥–∂–µ—Ç–∞ (—Ä–µ—Å—É—Ä—Å—ã):</label>
                                    <input type="number" id="budget_limit" min="0" placeholder="–ù–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="exclude_trinkets" checked>
                                    –ò—Å–∫–ª—é—á–∏—Ç—å –∞–∫—Å–µ—Å—Å—É–∞—Ä—ã –∏–∑ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è
                                </label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" id="analyzeBtn">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏—è</button>
                </form>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...</p>
                <p id="loadingDetails"></p>
            </div>

            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <div id="characterInfo" class="character-info" style="display: none;"></div>
                    <div class="results-actions">
                        <button id="compareStrategiesBtn" class="btn-secondary">–°—Ä–∞–≤–Ω–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏</button>
                        <button id="exportJsonBtn" class="btn-secondary">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
                        <button id="saveProfileBtn" class="btn-secondary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                    </div>
                </div>

                <div id="resultMessage"></div>
                <div id="summaryCards" class="summary-cards"></div>
                <div id="resourcesInfo" class="resources-info" style="display: none;"></div>

                <!-- –¢–µ–∫—É—â–∞—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞ -->
                <div id="currentItemsSection">
                    <div class="section-header">
                        <h3>–¢–µ–∫—É—â–∞—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞:</h3>
                        <div class="visualization-toggle" id="currentVisualizationToggle">üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</div>
                    </div>
                    <div id="currentItems" class="items-grid"></div>
                    <div id="currentVisualization" class="items-visualization" style="display: none;"></div>
                </div>

                <!-- –§–∏–Ω–∞–ª—å–Ω–∞—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞ -->
                <div id="finalItemsSection" style="display: none;">
                    <div class="section-header">
                        <h3>–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:</h3>
                        <div class="visualization-toggle" id="finalVisualizationToggle">üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è</div>
                    </div>
                    <div id="finalItems" class="items-grid"></div>
                    <div id="finalVisualization" class="items-visualization" style="display: none;"></div>
                </div>

                <!-- –°–≤–æ–¥–∫–∞ –ø–æ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–µ–¥–º–µ—Ç–∞–º -->
                <div id="craftedSummary" class="crafted-summary" style="display: none;">
                    <h3>–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:</h3>
                    <div id="craftedItemsList"></div>
                </div>

                <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                <div id="recommendationsSection" class="recommendations-section" style="display: none;">
                    <h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h3>
                    <div id="recommendationsList"></div>
                </div>

                <div id="upgradesList" class="upgrades-list"></div>
                <div id="additionalInfo" class="stats-grid" style="display: none;"></div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π -->
            <div id="strategyComparisonModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π</h2>
                        <span class="close" id="closeStrategyComparison">&times;</span>
                    </div>
                    <div class="modal-body" id="strategyComparisonContent">
                        <div class="loading-spinner">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è...</div>
                    </div>
                </div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
            <div id="saveProfileModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
                        <span class="close" id="closeSaveProfile">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="profileName">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è:</label>
                            <input type="text" id="profileName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è">
                        </div>
                        <div class="form-group">
                            <label for="profileDescription">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                            <textarea id="profileDescription" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫ –ø—Ä–æ—Ñ–∏–ª—é"></textarea>
                        </div>
                        <button id="confirmSaveProfile" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let allRealms = [];
        let filteredRealms = [];
        let currentResults = null;

        // –û–ø–∏—Å–∞–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
        const strategyDescriptions = {
            'balanced': '–≠–∫–æ–Ω–æ–º–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∏–Ω–∏–º–∏–∑–∏—Ä—É–µ—Ç –∑–∞—Ç—Ä–∞—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏.',
            'cost_efficient': '–¢—â–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–æ–ª—å—à–µ —Ä–µ—Å—É—Ä—Å–æ–≤, –Ω–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–∏.',
            'fastest': '–ë—ã—Å—Ç—Ä–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –∑–∞—Ç—Ä–∞—Ç–∞–º–∏ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å—é.'
        };

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—ã–±–æ—Ä–∞
        document.addEventListener('DOMContentLoaded', function() {
            const strategySelect = document.getElementById('strategy');
            const strategyDescription = document.getElementById('strategyDescription');

            strategySelect.addEventListener('change', function() {
                strategyDescription.textContent = strategyDescriptions[this.value];
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤
            loadRealms();

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
        });

        function setupEventListeners() {
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            document.getElementById('advancedToggle').addEventListener('click', function() {
                const content = document.getElementById('advancedContent');
                content.style.display = content.style.display === 'none' ? 'block' : 'none';
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–∫—É—â–µ–π —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏
            document.getElementById('currentVisualizationToggle').addEventListener('click', function() {
                toggleVisualization('current');
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏
            document.getElementById('finalVisualizationToggle').addEventListener('click', function() {
                toggleVisualization('final');
            });

            // –ö–Ω–æ–ø–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
            document.getElementById('compareStrategiesBtn').addEventListener('click', compareStrategies);

            // –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ JSON
            document.getElementById('exportJsonBtn').addEventListener('click', exportJson);

            // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('saveProfileBtn').addEventListener('click', openSaveProfileModal);

            // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            document.getElementById('closeStrategyComparison').addEventListener('click', function() {
                document.getElementById('strategyComparisonModal').style.display = 'none';
            });

            document.getElementById('closeSaveProfile').addEventListener('click', function() {
                document.getElementById('saveProfileModal').style.display = 'none';
            });

            document.getElementById('confirmSaveProfile').addEventListener('click', saveProfile);

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
            window.addEventListener('click', function(event) {
                const strategyModal = document.getElementById('strategyComparisonModal');
                const saveModal = document.getElementById('saveProfileModal');

                if (event.target === strategyModal) {
                    strategyModal.style.display = 'none';
                }
                if (event.target === saveModal) {
                    saveModal.style.display = 'none';
                }
            });
        }

        function toggleVisualization(type) {
            const visualization = document.getElementById(type + 'Visualization');
            const toggle = document.getElementById(type + 'VisualizationToggle');

            if (visualization.style.display === 'none') {
                visualization.style.display = 'block';
                toggle.textContent = 'üìã –°–ø–∏—Å–æ–∫';
                renderVisualization(type);
            } else {
                visualization.style.display = 'none';
                toggle.textContent = 'üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è';
            }
        }

        function renderVisualization(type) {
            if (!currentResults) return;

            const items = currentResults[type + '_items'] || [];
            const container = document.getElementById(type + 'Visualization');

            // –°–æ–∑–¥–∞–µ–º —Ç–µ–ø–ª–æ–≤—É—é –∫–∞—Ä—Ç—É —É—Ä–æ–≤–Ω–µ–π –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            let visualizationHTML = '<div class="heatmap-container">';
            visualizationHTML += '<div class="heatmap-legend">';
            visualizationHTML += '<div class="legend-item"><div class="color-box" style="background-color: #9D9D9D;"></div><span>680-704</span></div>';
            visualizationHTML += '<div class="legend-item"><div class="color-box" style="background-color: #1EFF00;"></div><span>704-717</span></div>';
            visualizationHTML += '<div class="legend-item"><div class="color-box" style="background-color: #0070DD;"></div><span>717-727</span></div>';
            visualizationHTML += '<div class="legend-item"><div class="color-box" style="background-color: #FF8C00;"></div><span>727+</span></div>';
            visualizationHTML += '</div>';

            visualizationHTML += '<div class="heatmap-grid">';
            items.forEach(item => {
                const color = getItemColor(item.item_level);
                visualizationHTML += `
                    <div class="heatmap-item" style="background-color: ${color};" title="${item.readable_slot}: ${item.item_level}">
                        <div class="heatmap-item-icon">${item.slot_icon}</div>
                        <div class="heatmap-item-level">${item.item_level}</div>
                    </div>
                `;
            });
            visualizationHTML += '</div>';
            visualizationHTML += '</div>';

            container.innerHTML = visualizationHTML;
        }

        function getItemColor(itemLevel) {
            if (itemLevel >= 727) return "#FF8C00";  // –û—Ä–∞–Ω–∂–µ–≤—ã–π
            if (itemLevel >= 717) return "#0070DD";  // –°–∏–Ω–∏–π
            if (itemLevel >= 704) return "#1EFF00";  // –ó–µ–ª–µ–Ω—ã–π
            return "#9D9D9D";  // –°–µ—Ä—ã–π
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        async function loadRealms() {
            try {
                const response = await fetch('/api/realms');
                const data = await response.json();

                allRealms = data.realms;
                filteredRealms = [...allRealms];

                console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.realms.length} —Å–µ—Ä–≤–µ—Ä–æ–≤`);
            } catch (error) {
                console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        document.getElementById('characterForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const region = document.getElementById('region').value;
            const realm = document.getElementById('realm').value.trim();
            const characterName = document.getElementById('character_name').value.trim();
            const targetAverage = parseFloat(document.getElementById('target_average').value);
            const strategy = document.getElementById('strategy').value;
            const maxCraftedItems = parseInt(document.getElementById('max_crafted_items').value);
            const budgetLimit = document.getElementById('budget_limit').value ? parseInt(document.getElementById('budget_limit').value) : null;
            const excludeTrinkets = document.getElementById('exclude_trinkets').checked;

            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!realm) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä');
                return;
            }

            if (!characterName) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
                return;
            }

            if (isNaN(targetAverage) || targetAverage <= 0) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ü–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!allRealms.includes(realm)) {
                showError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            showLoading(`–ê–Ω–∞–ª–∏–∑ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ ${characterName}@${realm}...`);
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('analyzeBtn').disabled = true;

            try {
                const response = await fetch('/api/character', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        region: region,
                        realm: realm,
                        character_name: characterName,
                        target_average: targetAverage,
                        strategy: strategy,
                        max_crafted_items: maxCraftedItems,
                        budget_limit: budgetLimit,
                        exclude_trinkets: excludeTrinkets
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    currentResults = data;
                    displayResults(data);
                } else {
                    showError(data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É: ' + error.message);
            } finally {
                hideLoading();
                document.getElementById('analyzeBtn').disabled = false;
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
        document.getElementById('realm').addEventListener('input', function() {
            const input = this.value.toLowerCase();
            const suggestions = document.getElementById('realmSuggestions');

            if (input.length === 0) {
                suggestions.innerHTML = '';
                suggestions.style.display = 'none';
                return;
            }

            // –§–∏–ª—å—Ç—Ä—É–µ–º —Å–µ—Ä–≤–µ—Ä—ã
            filteredRealms = allRealms.filter(realm =>
                realm.toLowerCase().includes(input)
            ).slice(0, 10); // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏

            if (filteredRealms.length > 0) {
                suggestions.innerHTML = filteredRealms.map(realm =>
                    `<div class="suggestion-item" data-realm="${realm}">${realm}</div>`
                ).join('');
                suggestions.style.display = 'block';

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
                document.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', function() {
                        document.getElementById('realm').value = this.getAttribute('data-realm');
                        suggestions.style.display = 'none';
                    });
                });
            } else {
                suggestions.innerHTML = '<div class="suggestion-item no-results">–°–µ—Ä–≤–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                suggestions.style.display = 'block';
            }
        });

        // –°–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#realm') && !e.target.closest('#realmSuggestions')) {
                document.getElementById('realmSuggestions').style.display = 'none';
            }
        });

        function showLoading(message) {
            document.getElementById('loadingDetails').textContent = message;
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª–∞—Å—Å–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        function getDifficultyClass(difficulty) {
            switch(difficulty?.toLowerCase()) {
                case 'mythic':
                    return 'difficulty-mythic';
                case 'heroic':
                    return 'difficulty-heroic';
                case 'normal':
                    return 'difficulty-normal';
                default:
                    return 'difficulty-unknown';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
        function getDifficultyText(difficulty) {
            switch(difficulty?.toLowerCase()) {
                case 'mythic':
                    return 'Mythic';
                case 'heroic':
                    return 'Heroic';
                case 'normal':
                    return 'Normal';
                default:
                    return '';
            }
        }

        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const characterInfo = document.getElementById('characterInfo');
            const resultMessage = document.getElementById('resultMessage');
            const summaryCards = document.getElementById('summaryCards');
            const resourcesInfo = document.getElementById('resourcesInfo');
            const currentItems = document.getElementById('currentItems');
            const finalItemsSection = document.getElementById('finalItemsSection');
            const finalItems = document.getElementById('finalItems');
            const craftedSummary = document.getElementById('craftedSummary');
            const craftedItemsList = document.getElementById('craftedItemsList');
            const upgradesList = document.getElementById('upgradesList');
            const additionalInfo = document.getElementById('additionalInfo');
            const recommendationsSection = document.getElementById('recommendationsSection');
            const recommendationsList = document.getElementById('recommendationsList');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ
            if (data.character) {
                characterInfo.innerHTML = `
                    <h3>–ü–µ—Ä—Å–æ–Ω–∞–∂: ${data.character.name}</h3>
                    <p>–°–µ—Ä–≤–µ—Ä: ${data.character.realm} (${data.character.region})</p>
                    <p>–°—Ç—Ä–∞—Ç–µ–≥–∏—è: ${data.strategy_name}</p>
                `;
                characterInfo.style.display = 'block';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —ç–∫–∏–ø–∏—Ä–æ–≤–∫—É
            if (data.current_items && data.current_items.length > 0) {
                let itemsHTML = '';
                data.current_items.forEach(item => {
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                    const difficulty = item.difficulty || '';
                    const difficultyClass = getDifficultyClass(difficulty);
                    const difficultyText = getDifficultyText(difficulty);
                    const difficultyDisplay = difficultyText ? `<div class="item-difficulty ${difficultyClass}">${difficultyText}</div>` : '';

                    itemsHTML += `
                        <div class="item-card">
                            <div class="item-header">
                                <span class="item-icon">${item.slot_icon}</span>
                                <span class="item-slot">${item.readable_slot}</span>
                            </div>
                            <div class="item-icon-container">
                                <img src="${item.icon_url}" alt="${item.name}" class="item-icon-img" onerror="this.src='https://render.worldofwarcraft.com/eu/icons/56/inv_misc_questionmark.jpg'">
                            </div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-level">${item.item_level}</div>
                            ${difficultyDisplay}
                        </div>
                    `;
                });
                currentItems.innerHTML = itemsHTML;
                document.getElementById('currentItemsSection').style.display = 'block';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —ç–∫–∏–ø–∏—Ä–æ–≤–∫—É
            if (data.final_items && data.final_items.length > 0) {
                let finalItemsHTML = '';
                data.final_items.forEach(item => {
                    const craftedLabel = item.crafted ? '<div class="crafted-label">–ò–ó–ì–û–¢–û–í–õ–ï–ù</div>' : '';

                    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                    const difficulty = item.difficulty || '';
                    const difficultyClass = getDifficultyClass(difficulty);
                    const difficultyText = getDifficultyText(difficulty);
                    const difficultyDisplay = difficultyText ? `<div class="item-difficulty ${difficultyClass}">${difficultyText}</div>` : '';

                    finalItemsHTML += `
                        <div class="item-card ${item.crafted ? 'crafted-item' : ''}">
                            <div class="item-header">
                                <span class="item-icon">${item.slot_icon}</span>
                                <span class="item-slot">${item.readable_slot}</span>
                            </div>
                            <div class="item-icon-container">
                                <img src="${item.icon_url}" alt="${item.name}" class="item-icon-img" onerror="this.src='https://render.worldofwarcraft.com/eu/icons/56/inv_misc_questionmark.jpg'">
                                ${craftedLabel}
                            </div>
                            <div class="item-name">${item.name}</div>
                            <div class="item-level">${item.item_level}</div>
                            ${difficultyDisplay}
                        </div>
                    `;
                });
                finalItems.innerHTML = finalItemsHTML;
                finalItemsSection.style.display = 'block';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–¥–∫—É –ø–æ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º –ø—Ä–µ–¥–º–µ—Ç–∞–º
            if (data.crafted_items_log && data.crafted_items_log.length > 0) {
                let craftedHTML = '<div class="crafted-items-grid">';
                data.crafted_items_log.forEach((item, index) => {
                    craftedHTML += `
                        <div class="crafted-item-card">
                            <div class="crafted-item-header">
                                <span class="crafted-item-icon">${item.item_slot_icon}</span>
                                <span class="crafted-item-slot">${item.item_slot}</span>
                            </div>
                            <div class="crafted-item-icon-container">
                                <img src="${item.item_icon_url}" alt="${item.item_name}" class="crafted-item-icon-img" onerror="this.src='https://render.worldofwarcraft.com/eu/icons/56/inv_misc_questionmark.jpg'">
                            </div>
                            <div class="crafted-item-name">${item.item_name}</div>
                            <div class="crafted-item-change">${item.from} ‚Üí ${item.to}</div>
                            <div class="crafted-item-cost">${item.cost_formatted}</div>
                        </div>
                    `;
                });
                craftedHTML += '</div>';
                craftedItemsList.innerHTML = craftedHTML;
                craftedSummary.style.display = 'block';
            } else {
                craftedSummary.style.display = 'none';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
            if (data.recommendations && data.recommendations.length > 0) {
                let recommendationsHTML = '<div class="recommendations-list">';
                data.recommendations.forEach(rec => {
                    recommendationsHTML += `
                        <div class="recommendation-item ${rec.type}">
                            <div class="recommendation-icon">‚ÑπÔ∏è</div>
                            <div class="recommendation-content">
                                <div class="recommendation-message">${rec.message}</div>
                                ${rec.items ? `<div class="recommendation-details">–ü—Ä–µ–¥–º–µ—Ç—ã: ${rec.items.join(', ')}</div>` : ''}
                                ${rec.slots ? `<div class="recommendation-details">–°–ª–æ—Ç—ã: ${rec.slots.join(', ')}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                recommendationsHTML += '</div>';
                recommendationsList.innerHTML = recommendationsHTML;
                recommendationsSection.style.display = 'block';
            } else {
                recommendationsSection.style.display = 'none';
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (data.message) {
                const messageType = data.goal_reached ? 'success' : (data.message.includes('–¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ') ? 'success' : 'warning');
                resultMessage.innerHTML = `<div class="${messageType}">${data.message}</div>`;
            } else if (data.goal_reached) {
                resultMessage.innerHTML = `<div class="success">‚úÖ –¶–µ–ª–µ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ!</div>`;
            } else {
                resultMessage.innerHTML = `<div class="warning">‚ö†Ô∏è ${data.message || '–¶–µ–ª—å –Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–∏–º–æ–µ —Å—Ä–µ–¥–Ω–µ–µ: ' + data.final_average}</div>`;
            }

            // –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            summaryCards.innerHTML = `
                <div class="card">
                    <h3>–¢–µ–∫—É—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ</h3>
                    <div class="value">${data.current_average}</div>
                </div>
                <div class="card">
                    <h3>–¶–µ–ª–µ–≤–æ–µ —Å—Ä–µ–¥–Ω–µ–µ</h3>
                    <div class="value">${data.target_average}</div>
                </div>
                <div class="card">
                    <h3>–ò—Ç–æ–≥–æ–≤–æ–µ —Å—Ä–µ–¥–Ω–µ–µ</h3>
                    <div class="value">${data.final_average}</div>
                </div>
                <div class="card resources-card">
                    <h3>–í—Å–µ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤</h3>
                    <div class="value">${data.total_resources_cost}</div>
                </div>
                <div class="card">
                    <h3>–£–ª—É—á—à–µ–Ω–∏—è</h3>
                    <div class="value">${data.upgrades_count}</div>
                </div>
                <div class="card crafted-card">
                    <h3>–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–æ</h3>
                    <div class="value">${data.crafted_items}</div>
                </div>
            `;

            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Å—É—Ä—Å–∞—Ö
            if (data.resources_needed) {
                resourcesInfo.innerHTML = `
                    <h3>–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã:</h3>
                    <div class="resource-item">
                        <span class="resource-name">–†–µ—Å—É—Ä—Å ‚Ññ1:</span>
                        <span class="resource-cost">${data.resources_needed.resource1}</span>
                    </div>
                    <div class="resource-item">
                        <span class="resource-name">–†–µ—Å—É—Ä—Å ‚Ññ2:</span>
                        <span class="resource-cost">${data.resources_needed.resource2}</span>
                    </div>
                    <div class="resource-item">
                        <span class="resource-name">–†–µ—Å—É—Ä—Å ‚Ññ3:</span>
                        <span class="resource-cost">${data.resources_needed.resource3}</span>
                    </div>
                    <div class="resource-item" style="border-top: 2px solid #3498db; margin-top: 8px; padding-top: 8px;">
                        <span class="resource-name"><strong>–í—Å–µ–≥–æ:</strong></span>
                        <span class="resource-cost"><strong>${data.total_resources_cost}</strong></span>
                    </div>
                `;
                resourcesInfo.style.display = 'block';
            }

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            if (data.processing_time) {
                additionalInfo.innerHTML = `
                    <div class="stat-item">
                        <div class="stat-label">–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</div>
                        <div class="stat-value">${data.processing_time} —Å–µ–∫</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                        <div class="stat-value">${data.efficiency} –ø/1000—Ä</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–æ</div>
                        <div class="stat-value">${data.crafted_items}/${9}</div>
                    </div>
                `;
                additionalInfo.style.display = 'grid';
            }

            // –°–ø–∏—Å–æ–∫ —É–ª—É—á—à–µ–Ω–∏–π —Å –∏–∫–æ–Ω–∫–∞–º–∏
            if (data.upgrades && data.upgrades.length > 0) {
                let upgradesHTML = '<h3>–ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω —É–ª—É—á—à–µ–Ω–∏–π:</h3>';
                data.upgrades.forEach(upgrade => {
                    const isCrafted = upgrade.type === 'crafted';
                    const typeClass = isCrafted ? 'crafted' : '';
                    const typeText = isCrafted ? '–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ' : '–£–ª—É—á—à–µ–Ω–∏–µ';

                    upgradesHTML += `
                        <div class="upgrade-item ${isCrafted ? 'crafted' : ''}">
                            <div class="upgrade-icon">${upgrade.item_slot_icon}</div>
                            <div class="upgrade-content">
                                <div class="upgrade-header">
                                    <span>–®–∞–≥ ${upgrade.step}: ${upgrade.item_slot}</span>
                                    <span class="upgrade-type ${typeClass}">${typeText}</span>
                                </div>
                                <div class="upgrade-item-details">
                                    <img src="${upgrade.item_icon_url}" alt="${upgrade.item_name}" class="upgrade-item-icon" onerror="this.src='https://render.worldofwarcraft.com/eu/icons/56/inv_misc_questionmark.jpg'">
                                    <div class="upgrade-item-info">
                                        <div class="upgrade-item-name">${upgrade.item_name}</div>
                                        <div class="upgrade-details">
                                            ${upgrade.from} ‚Üí ${upgrade.to} (${upgrade.cost_formatted})
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                upgradesList.innerHTML = upgradesHTML;
            } else if (data.message && data.message.includes('–¥–æ—Å—Ç–∏–≥–Ω—É—Ç–æ')) {
                upgradesList.innerHTML = '<p>–£–ª—É—á—à–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è - —Ü–µ–ª—å —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!</p>';
            } else {
                upgradesList.innerHTML = '<p>–£–ª—É—á—à–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–ª–∏ –Ω–µ –≤–æ–∑–º–æ–∂–Ω—ã.</p>';
            }

            resultsSection.style.display = 'block';
        }

        function showError(message) {
            const resultsSection = document.getElementById('resultsSection');
            const resultMessage = document.getElementById('resultMessage');

            resultMessage.innerHTML = `<div class="error">‚ùå ${message}</div>`;
            document.getElementById('characterInfo').style.display = 'none';
            document.getElementById('summaryCards').innerHTML = '';
            document.getElementById('resourcesInfo').style.display = 'none';
            document.getElementById('currentItemsSection').style.display = 'none';
            document.getElementById('finalItemsSection').style.display = 'none';
            document.getElementById('craftedSummary').style.display = 'none';
            document.getElementById('recommendationsSection').style.display = 'none';
            document.getElementById('upgradesList').innerHTML = '';
            document.getElementById('additionalInfo').style.display = 'none';
            resultsSection.style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
        async function compareStrategies() {
            if (!currentResults || !currentResults.character) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
                return;
            }

            const modal = document.getElementById('strategyComparisonModal');
            const content = document.getElementById('strategyComparisonContent');

            content.innerHTML = '<div class="loading-spinner">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è...</div>';
            modal.style.display = 'block';

            try {
                const response = await fetch('/api/strategies/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        region: currentResults.character.region.toLowerCase().replace('(', '').replace(')', ''),
                        realm: currentResults.character.realm,
                        character_name: currentResults.character.name,
                        target_average: currentResults.target_average
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    renderStrategyComparison(data.comparison);
                } else {
                    content.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${data.error}</div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}</div>`;
            }
        }

        function renderStrategyComparison(comparison) {
            const content = document.getElementById('strategyComparisonContent');

            let html = `
                <div class="strategy-comparison">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>–°—Ç—Ä–∞—Ç–µ–≥–∏—è</th>
                                <th>–í—Å–µ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤</th>
                                <th>–®–∞–≥–æ–≤</th>
                                <th>–ò–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–æ</th>
                                <th>–ò—Ç–æ–≥–æ–≤–æ–µ —Å—Ä–µ–¥–Ω–µ–µ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            Object.keys(comparison).forEach(strategyKey => {
                const strategy = comparison[strategyKey];
                html += `
                    <tr>
                        <td>${strategy.strategy_name}</td>
                        <td>${strategy.total_cost}</td>
                        <td>${strategy.steps}</td>
                        <td>${strategy.crafted_items}</td>
                        <td>${strategy.final_average}</td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                    <div class="comparison-note">
                        <p>üí° –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ª—É—á—à–µ –≤—Å–µ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–∏–º —Ü–µ–ª—è–º –∏ —Ä–µ—Å—É—Ä—Å–∞–º.</p>
                    </div>
                </div>
            `;

            content.innerHTML = html;
        }

        function exportJson() {
            if (!currentResults) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }

            const dataStr = JSON.stringify(currentResults, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const exportFileDefaultName = `raider-optimizer-${new Date().toISOString().slice(0,10)}.json`;

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function openSaveProfileModal() {
            if (!currentResults) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞');
                return;
            }

            document.getElementById('profileName').value = '';
            document.getElementById('profileDescription').value = '';
            document.getElementById('saveProfileModal').style.display = 'block';
        }

        async function saveProfile() {
            const profileName = document.getElementById('profileName').value.trim();
            const profileDescription = document.getElementById('profileDescription').value.trim();

            if (!profileName) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è');
                return;
            }

            try {
                const response = await fetch('/api/profiles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: profileName,
                        description: profileDescription,
                        data: currentResults
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
                    document.getElementById('saveProfileModal').style.display = 'none';
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è: ' + data.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + error.message);
            }
        }
    </script>
</body>
</html>
